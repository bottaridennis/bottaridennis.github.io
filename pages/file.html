<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Oltre il Segno ‚Äî Gioco del Limite (60 caselle)</title>
<style>
  :root{
    --bg:#0c0f14; --panel:#151a22; --ink:#e9edf3; --muted:#a7b0c0; --grid:#232a36;
    --paura:#ff6b6b; --confine:#ffd166; --oltre:#06d6a0; --accent:#7c5cff;
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{
    margin:0; background:
      radial-gradient(1200px 800px at 10% -10%, #111728 0%, #0a0d14 40%, #06070b 100%),
      var(--bg);
    color:var(--ink);
    font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
    -webkit-tap-highlight-color:transparent; overflow-x:hidden;
  }
  header{padding:16px 16px 8px; text-align:center}
  h1{margin:0; font-weight:800; letter-spacing:.2px; font-size:clamp(1.1rem,3.8vw,1.6rem)}
  .sub{color:var(--muted); margin-top:4px; font-size:clamp(.8rem,3.2vw,.95rem)}

  /* ========= LAYOUT ========= */
  .wrap{
    display:grid; grid-template-columns: 320px 1fr 360px;
    gap:14px; padding:14px; padding-bottom:max(14px, env(safe-area-inset-bottom));
  }
  @media (max-width:1100px){ .wrap{grid-template-columns:1fr} }

  .panel{
    background:linear-gradient(180deg,#171c26,#121720);
    border:1px solid #222a38; border-radius:14px; padding:14px;
    box-shadow:0 20px 50px rgba(0,0,0,.35);
  }
  .panel h2{margin:2px 0 10px; font-size:clamp(.95rem,3.4vw,1.05rem); letter-spacing:.3px}

  .names-grid{display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-top:8px}
  .names-grid input{
    background:#111726; color:#e9eefc; border:1px solid #29324a; border-radius:10px;
    padding:.55rem .7rem; min-height:40px; width:100%;
  }
  .hint{color:#95a2bd; font-size:.85rem; margin-top:6px}

  /* ========= BOARD ========= */
  .board{width:100%; display:grid; gap:6px; padding:10px; position:relative;}
  .board.cols-10{ grid-template-columns:repeat(10, 1fr); } /* desktop 10x6 */
  .board.cols-6  { grid-template-columns:repeat(6, 1fr); } /* mobile 6x10 */

  .cell{
    aspect-ratio:1/1; border:1px solid var(--grid); border-radius:10px;
    display:flex; align-items:center; justify-content:center;
    position:relative; overflow:hidden; background:#0f1420;
  }
  .cell::after{
    content:attr(data-i);
    position:absolute; top:6px; left:8px; font-size:clamp(.62rem,2.6vw,.75rem); color:#7c879b; opacity:.85;
  }
  .cell .type{position:absolute; bottom:6px; right:6px; font-size:clamp(.9rem,3.5vw,1.1rem)}
  .cell.paura{outline:2px solid rgba(255,107,107,.28); box-shadow:inset 0 0 0 2px rgba(255,107,107,.14)}
  .cell.confine{outline:2px solid rgba(255,209,102,.28); box-shadow:inset 0 0 0 2px rgba(255,209,102,.14)}
  .cell.oltre{outline:2px solid rgba(6,214,160,.28); box-shadow:inset 0 0 0 2px rgba(6,214,160,.14)}
  .cell.start{background:#0d1522; border-style:dashed; border-color:#3b4a66}
  .cell.finish{background:#0d1522; border-style:dashed; border-color:#7c5cff}

  .cell.current{
    box-shadow: 0 0 0 3px rgba(124,92,255,.55), 0 0 25px rgba(124,92,255,.35) inset;
    border-color:#7c5cff;
  }

  /* ========= BADGE ANGOLARI ========= */
  .badge-corner{
    position:absolute; top:6px; right:6px; display:flex; flex-direction:column; gap:4px;
    align-items:flex-end; pointer-events:none;
  }
  .dot{
    width:18px; height:18px; border-radius:50%; border:2px solid rgba(255,255,255,.9);
    color:#0b0b0b; font-weight:900; font-size:11px; display:grid; place-items:center;
    box-shadow:0 3px 8px rgba(0,0,0,.35);
  }
  .dot.active{ outline:2px solid rgba(124,92,255,.85) }
  .d1{background:#ff6b6b}.d2{background:#4dabf7}.d3{background:#ffd166}
  .d4{background:#06d6a0}.d5{background:#f06595}.d6{background:#7c5cff}

  /* ========= CONTROLLI ========= */
  .row-flex{display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap}
  button{
    background:#1b2231; color:#eaf0ff; border:1px solid #2b3650; padding:.7rem .95rem;
    border-radius:12px; font-weight:800; cursor:pointer;
    transition:.15s transform,.15s background,.15s border;
    min-height:44px;
  }
  button:hover{transform:translateY(-1px); background:#20293b}
  button.primary{background:linear-gradient(180deg,#2b3bff,#7c5cff); border-color:#7c5cff}
  button:disabled{opacity:.55; cursor:not-allowed}
  .field{display:flex; gap:8px; align-items:center}
  select{
    background:#111726; color:#e9eefc; border:1px solid #29324a; border-radius:12px; padding:.6rem .7rem; min-height:44px;
  }
  @media (max-width:768px){
    .controls-grid{display:grid; grid-template-columns:1fr 1fr; gap:8px}
    .row-flex > div:last-child{width:100%; display:grid; grid-template-columns:1fr 1fr; gap:8px}
  }

  /* ========= CARTE ========= */
  .cardbox{display:grid; grid-template-columns:1fr; gap:10px}
  .prompt{border:1px solid #27314a; background:linear-gradient(180deg,#141a25,#101521); border-radius:12px; padding:12px}
  .prompt h3{margin:0 0 6px; font-size:clamp(.95rem,3.6vw,1rem); color:#d9e2ff}
  .prompt p{margin:0; color:#dfe6ff; font-size:clamp(.9rem,3.6vw,1rem)}
  .badge{display:inline-flex; align-items:center; gap:6px; padding:.25rem .55rem; border-radius:999px; font-weight:800; font-size:.78rem; border:1px solid}
  .b-paura{color:#ffc7c7; border-color:rgba(255,107,107,.5); background:rgba(255,107,107,.12)}
  .b-confine{color:#fff0c8; border-color:rgba(255,209,102,.55); background:rgba(255,209,102,.12)}
  .b-oltre{color:#b9ffea; border-color:rgba(6,214,160,.55); background:rgba(6,214,160,.12)}

  /* ========= DADO 3D ========= */
  .dice-overlay{position:fixed; inset:0; display:grid; place-items:center; pointer-events:none; transition:opacity .25s ease; opacity:0; padding:16px}
  .dice-overlay.visible{opacity:1}
  .dice-wrap{width:clamp(84px,26vw,120px); height:clamp(84px,26vw,120px); perspective:900px; filter:drop-shadow(0 30px 50px rgba(0,0,0,.5)); transform:scale(.9); transition:transform .25s ease}
  .dice-overlay.visible .dice-wrap{transform:scale(1)}
  .dice{position:relative; width:100%; height:100%; transform-style:preserve-3d; transition:transform 1s cubic-bezier(.19,.9,.22,1.12)}
  .face{position:absolute; inset:0; display:grid; place-items:center; background:linear-gradient(145deg,#e8edf7,#cdd6ea); border-radius:14px; box-shadow:inset 0 0 0 2px #aab7d6}
  .pips{display:grid; gap:10px; grid-template-columns:repeat(3,1fr); width:70%; height:70%}
  .pip{width:clamp(10px,2.7vw,16px); height:clamp(10px,2.7vw,16px); background:#1e2433; border-radius:50%}
  .pip.light{background:#2a3350}
  .f1{ transform: translateZ(60px) } .f2{ transform: rotateY(180deg) translateZ(60px) }
  .f3{ transform: rotateY(90deg)  translateZ(60px) } .f4{ transform: rotateY(-90deg) translateZ(60px) }
  .f5{ transform: rotateX(90deg)  translateZ(60px) } .f6{ transform: rotateX(-90deg) translateZ(60px) }

  /* ========= POSIZIONI ========= */
  .statuslist{display:flex; flex-direction:column; gap:6px; margin:0; padding:0; list-style:none}
  .statusitem{display:flex; align-items:center; justify-content:space-between; gap:8px; background:#111726; border:1px solid #26304a; border-radius:10px; padding:.5rem .7rem}
  .badge-mini{min-width:28px; height:28px; border-radius:50%; display:grid; place-items:center; font-weight:800; color:#0b0b0b; border:2px solid rgba(255,255,255,.2)}
  .mini1{background:#ff6b6b}.mini2{background:#4dabf7}.mini3{background:#ffd166;color:#1b1b1b}.mini4{background:#06d6a0;color:#0b2b22}.mini5{background:#f06595}.mini6{background:#7c5cff}

  @media (prefers-reduced-motion: reduce){ .dice,.dice-overlay,button{transition:none !important} }

  /* ========= TABS solo mobile (sticky) ========= */
  .tabs{display:none}
  @media (max-width:900px){
    .tabs{
      position:sticky; bottom:0; left:0; right:0;
      display:grid; grid-template-columns:repeat(4,1fr); gap:8px;
      padding:10px 14px env(safe-area-inset-bottom);
      background: linear-gradient(180deg, rgba(6,7,11,0), rgba(6,7,11,.9) 40%, rgba(6,7,11,1));
      backdrop-filter: blur(6px);
      border-top:1px solid #222a38;
      z-index:30;
    }
    .tabbtn{
      border-radius:12px; border:1px solid #2b3650; background:#141a22;
      color:#cfe1ff; padding:.6rem .3rem; min-height:42px; font-weight:800;
    }
    .tabbtn.active{ border-color:#7c5cff; box-shadow:0 0 0 2px rgba(124,92,255,.25) inset }
  }
</style>
</head>
<body>

<header>
  <h1>Oltre il Segno ‚Äî Gioco del Limite</h1>
  <div class="sub">Collaborativo, 2‚Äì6 giocatori ‚Ä¢ 60 caselle ‚Ä¢ mobile con tab a layer ‚Ä¢ Dado 3D</div>
</header>

<div class="wrap">

  <!-- CONTROLLI -->
  <section class="panel" id="panel-gioco" data-section="gioco">
    <h2>Impostazioni</h2>
    <div class="row-flex" style="margin-bottom:10px">
      <div class="field">
        <label for="players">Giocatori</label>
        <select id="players" aria-label="Numero giocatori">
          <option>2</option><option>3</option><option>4</option><option>5</option><option>6</option>
        </select>
      </div>
      <button id="startBtn" class="primary">Nuova Partita</button>
    </div>

    <!-- Nomi Giocatori -->
    <div>
      <button id="toggleNames" type="button">Nomi giocatori</button>
      <div id="namesBox" class="names-grid" style="display:none"></div>
      <div class="hint" id="namesHint" style="display:none">Suggerimento: i nomi compaiono in Turno, Posizioni e come tooltip sulle pedine.</div>
    </div>

    <div class="legend" role="list" style="display:flex;gap:8px;flex-wrap:wrap;margin:12px 0 8px">
      <span class="tag" role="listitem">üò® Paura</span>
      <span class="tag" role="listitem">üöß Confine</span>
      <span class="tag" role="listitem">üå± Oltre</span>
      <span class="tag" role="listitem">üèÅ Arrivo</span>
    </div>

    <h2>Turno & Azioni</h2>
    <div class="row-flex" style="margin-bottom:8px">
      <div id="turnInfo" aria-live="polite">‚Äî</div>
      <div class="controls-grid">
        <button id="rollBtn">Rolla Dado</button>
        <button id="nextBtn">Avanti Turno</button>
      </div>
    </div>
    <div class="controls-grid">
      <button id="drawBtn">Pesca Carta</button>
      <button id="toggleDice">Mostra/Nascondi Dado</button>
    </div>
  </section>

  <!-- BOARD -->
  <section class="panel" id="panel-board" data-section="board">
    <h2>Tabellone (60 caselle)</h2>
    <div id="board" class="board"></div>
  </section>

  <!-- CARTE -->
  <section class="panel" id="panel-carta" data-section="carta">
    <h2>Carta</h2>
    <div class="cardbox">
      <div class="prompt">
        <h3 id="cardTitle">Nessuna carta pescata</h3>
        <p id="cardText" style="color:#bfc9df">Rolla il dado e muovi. Se la casella mostra üò®/üöß/üå±, pesca una carta della categoria indicata.</p>
      </div>
      <div class="prompt" style="opacity:.95">
        <h3>Regole Lampo</h3>
        <p style="color:#c8d3ee">
          A turno: rolla ‚Üí muovi ‚Üí risolvi. Sulle caselle colorate pesca e confrontatevi. La cella del giocatore di turno √® evidenziata. Vince chi arriva a üèÅ; opzionale: vittoria collettiva se tutti condividono un ‚Äúpasso oltre‚Äù.
        </p>
      </div>
    </div>
  </section>

  <!-- POSIZIONI -->
  <section class="panel" id="panel-posizioni" data-section="posizioni">
    <h2>Posizioni</h2>
    <ul id="status" class="statuslist"></ul>
  </section>
</div>

<!-- TABS (solo mobile) -->
<nav class="tabs" id="tabs">
  <button class="tabbtn" data-tab="gioco">üéÆ Gioco</button>
  <button class="tabbtn" data-tab="board">üó∫Ô∏è Tabellone</button>
  <button class="tabbtn" data-tab="carta">üÉè Carta</button>
  <button class="tabbtn" data-tab="posizioni">üë• Posizioni</button>
</nav>

<!-- DADO 3D -->
<div class="dice-overlay" id="diceOverlay" aria-hidden="true">
  <div class="dice-wrap">
    <div class="dice" id="dice">
      <div class="face f1"><div class="pips"><span></span><span></span><span></span><span></span><span class="pip"></span><span></span><span></span><span></span><span></span></div></div>
      <div class="face f2"><div class="pips"><span class="pip"></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span class="pip"></span></div></div>
      <div class="face f3"><div class="pips"><span class="pip"></span><span></span><span></span><span></span><span class="pip light"></span><span></span><span></span><span></span><span class="pip"></span></div></div>
      <div class="face f4"><div class="pips"><span class="pip"></span><span></span><span class="pip"></span><span></span><span></span><span></span><span class="pip"></span><span></span><span class="pip"></span></div></div>
      <div class="face f5"><div class="pips"><span class="pip"></span><span></span><span class="pip"></span><span></span><span class="pip"></span><span></span><span class="pip"></span><span></span><span class="pip"></span></div></div>
      <div class="face f6"><div class="pips"><span class="pip"></span><span></span><span class="pip"></span><span class="pip"></span><span></span><span class="pip"></span><span class="pip"></span><span></span><span class="pip"></span></div></div>
    </div>
  </div>
</div>

<script>
/* ==================== CARTE ==================== */
const cartePaura = [
"Hai paura di sbagliare davanti agli altri. Rischi o ti tiri indietro?",
"Ti chiedono un‚Äôopinione sincera ma impopolare. La dici o taci?",
"Sei in gruppo ma ti senti invisibile. Ti fai notare o resti in silenzio?",
"Hai paura di deludere chi conta su di te. Fingi sicurezza o ammetti fragilit√†?",
"Tutti ridono di un errore. Ti unisci alle risate o difendi chi ha sbagliato?",
"Non ti senti all‚Äôaltezza di un compito. Provi lo stesso o lo lasci a qualcuno?",
"Hai paura di mostrare emozioni. Ti chiudi o ti lasci vedere per come sei?",
"Ti accorgi che un amico sta meglio di te. Lo sostieni o ti chiudi nell‚Äôinvidia?",
"Devi parlare di qualcosa che ti mette a disagio. Lo affronti o cambi argomento?",
"Ti senti giudicato per come ti vesti o ti esprimi. Ti adegui o resti te stesso?",
"Hai fallito in qualcosa di importante. Ne parli o lo nascondi?",
"Il gruppo prende una strada sbagliata. Li segui o ti opponi?",
"Hai paura di essere frainteso. Ti spieghi meglio o lasci correre?",
"Non vieni scelto. Ti arrendi o cerchi un altro modo per contribuire?",
"Devi chiedere aiuto ma temi di sembrare debole. Chiedi o taci?",
"Hai paura del giudizio online. Pubblicheresti lo stesso?",
"Ti confronti con qualcuno pi√π bravo. Ti ispiri o ti scoraggi?",
"Hai promesso qualcosa che non riesci a mantenere. Confessi o nascondi?",
"Ti accorgi di sbagliare davanti a tutti. Ti fermi o prosegui?",
"Hai paura di crescere. Resti dove sei o affronti il cambiamento?"
];
const carteConfine = [
"Un adulto impone una regola che non capisci. Obbedisci o chiedi spiegazioni?",
"Ti propongono di copiare per aiutare un amico. Accetti o rifiuti?",
"Qualcuno infrange una regola del gruppo. Lo segnali o lasci correre?",
"Devi scegliere tra due persone in conflitto. Prendi posizione o resti neutrale?",
"Ricevi un segreto pesante. Lo tieni o chiedi aiuto a un adulto?",
"Il gruppo vuole fare qualcosa di rischioso. Ti opponi o partecipi?",
"Ti dicono ‚Äúnon puoi farlo‚Äù. Cerchi un modo diverso o rinunci?",
"Hai troppi impegni. Rinunci a qualcosa o ti carichi tutto addosso?",
"Ti senti escluso da una decisione. Reclami il tuo spazio o accetti?",
"Ti accorgi che stai superando i tuoi limiti fisici. Ti fermi o forzi?",
"Vedi qualcuno oltrepassare il limite verso un altro. Intervieni o resti in disparte?",
"Devi scegliere tra la verit√† e la protezione di un amico. Cosa fai?",
"Il gruppo vota per una scelta che non condividi. Ti adegui o resti fedele alla tua idea?",
"Ti impongono una scadenza impossibile. Ti organizzi o protesti?",
"Ti trovi davanti a un divieto ingiusto. Lo rispetti o lo metti in discussione?",
"Un compagno supera un tuo confine personale. Lo affronti o lo lasci passare?",
"Hai un talento che altri vogliono usare a modo loro. Ti lasci guidare o rivendichi libert√†?",
"Sei testimone di un‚Äôingiustizia. Resti in silenzio o la denunci?",
"Devi scegliere tra rispetto e sincerit√†. Cosa pesa di pi√π?",
"Ti viene chiesto di perdonare qualcuno. Sei pronto o non ancora?"
];
const carteOltre = [
"Racconta un momento in cui hai affrontato una paura.",
"Descrivi una volta in cui ti sei sentito libero dopo aver detto ‚Äúno‚Äù.",
"Parla di una persona che ti ha aiutato a superare un limite.",
"Ricorda un rischio che hai corso e che ti ha fatto crescere.",
"Cita una tua piccola vittoria quotidiana.",
"Racconta una volta in cui hai sbagliato ma hai imparato qualcosa.",
"Qual √® un limite che oggi vedi come protezione e non pi√π come prigione?",
"Descrivi un sogno che prima ti sembrava impossibile e ora non pi√π.",
"Racconta una volta in cui ti sei sentito davvero te stesso.",
"Qual √® una paura che vuoi ancora affrontare?",
"Ricorda una persona che ti ha mostrato un nuovo modo di vedere le cose.",
"Descrivi un momento in cui hai chiesto aiuto e hai scoperto che non era debolezza.",
"Racconta una volta in cui hai avuto il coraggio di dire la verit√†.",
"Qual √® una regola che hai imparato a capire col tempo?",
"Parla di una volta in cui hai aiutato qualcuno a superare un limite.",
"Qual √® un confine che rispetti perch√© ti fa stare bene?",
"Descrivi un momento in cui hai capito che il limite era dentro di te, non fuori.",
"Racconta una volta in cui hai scelto la calma invece della reazione.",
"Pensa a qualcosa che ti spaventava da piccolo e oggi ti fa sorridere.",
"Condividi un piccolo passo ‚Äúoltre‚Äù che vuoi fare nei prossimi giorni."
];

/* ==================== RESPONSIVE BOARD SIZE ==================== */
function getGridDims(){
  return (window.innerWidth <= 900) ? {cols:6, rows:10} : {cols:10, rows:6};
}

/* ==================== STATE ==================== */
let sizeCols=10, sizeRows=6, totalCells=60;
const boardEl = document.getElementById('board');
let cellRefs = [];
let players = 2;
let positions = [];
let current = 0;
let gameOn = false;
let playerNames = []; // <- nomi

// Pattern caselle
const pattern = ["paura","confine","oltre","confine","paura","oltre","confine","oltre","paura","confine"];

/* ==================== BOARD ==================== */
function buildBoard(){
  const dims = getGridDims();
  sizeCols = dims.cols; sizeRows = dims.rows; totalCells = sizeCols * sizeRows;
  boardEl.classList.toggle('cols-10', sizeCols===10);
  boardEl.classList.toggle('cols-6',  sizeCols===6);

  boardEl.innerHTML = '';
  cellRefs = [];
  for(let r=0;r<sizeRows;r++){
    for(let c=0;c<sizeCols;c++){
      const cell = document.createElement('div');
      cell.className='cell';
      boardEl.appendChild(cell);
    }
  }
  // zig-zag
  const order = [];
  for(let r=0;r<sizeRows;r++){
    const row = [];
    for(let c=0;c<sizeCols;c++) row.push(r*sizeCols + c);
    if(r%2===1) row.reverse();
    order.push(...row);
  }
  order.forEach((idx, n)=>{
    const cell = boardEl.children[idx];
    const num = n+1;
    cell.dataset.i = num;
    if(num===1){ cell.classList.add('start'); cell.innerHTML = '<div class="type">üèÅ</div>'; }
    else if(num===totalCells){ cell.classList.add('finish'); cell.innerHTML = '<div class="type">üèÅ</div>'; }
    else{
      const t = pattern[(num-2) % pattern.length];
      cell.classList.add(t);
      const emoji = t==='paura'?'üò®':t==='confine'?'üöß':'üå±';
      const tag = document.createElement('div'); tag.className='type'; tag.textContent = emoji;
      cell.appendChild(tag);
    }
    const badge = document.createElement('div'); badge.className = 'badge-corner'; cell.appendChild(badge);
    cellRefs.push(cell);
  });
}

function markCurrentCell(){
  cellRefs.forEach(c=>c.classList.remove('current'));
  const cell = cellRefs[(positions[current]??1)-1];
  if(cell) cell.classList.add('current');
}

function renderTokens(){
  cellRefs.forEach(c=>{
    const bc = c.querySelector('.badge-corner'); if(bc) bc.innerHTML='';
  });
  const map = new Map();
  positions.forEach((pos, idx)=>{
    const key = Math.max(1, Math.min(totalCells, pos));
    if(!map.has(key)) map.set(key, []);
    map.get(key).push(idx);
  });
  map.forEach((arr, pos)=>{
    const cell = cellRefs[pos-1];
    const corner = cell.querySelector('.badge-corner');
    arr.forEach(idx=>{
      const dot = document.createElement('div');
      dot.className = `dot d${idx+1}` + (idx===current ? ' active' : '');
      dot.textContent = idx+1;
      dot.title = playerNames[idx] || `Giocatore ${idx+1}`;
      corner.appendChild(dot);
    });
  });
}

/* ==================== POSIZIONI ==================== */
const statusEl = document.getElementById('status');
function renderStatus(){
  statusEl.innerHTML = '';
  for(let i=0;i<players;i++){
    const li = document.createElement('li');
    li.className='statusitem';
    const mini = `<span class="badge-mini mini${i+1}">${i+1}</span>`;
    const here = positions[i];
    const name = playerNames[i] || `Giocatore ${i+1}`;
    li.innerHTML = `${mini} <strong>${name}</strong> <span>Casella ${here}</span>`;
    if(i===current) li.style.boxShadow = '0 0 0 2px rgba(124,92,255,.5) inset';
    statusEl.appendChild(li);
  }
}

/* ==================== DADO 3D ==================== */
const diceOverlay = document.getElementById('diceOverlay');
const dice = document.getElementById('dice');
let diceVisible = false;
function showDice(){ diceOverlay.classList.add('visible'); diceOverlay.setAttribute('aria-hidden','false'); diceVisible = true; }
function hideDice(){ diceOverlay.classList.remove('visible'); diceOverlay.setAttribute('aria-hidden','true'); diceVisible = false; }
document.getElementById('toggleDice').addEventListener('click', ()=>{ diceVisible ? hideDice() : showDice(); });

const faceRotations = { 1:{x:0,y:0}, 2:{x:0,y:180}, 3:{x:0,y:-90}, 4:{x:0,y:90}, 5:{x:-90,y:0}, 6:{x:90,y:0} };
function rollVisual(to){
  const extraX = (Math.floor(Math.random()*4))*360;
  const extraY = (Math.floor(Math.random()*4))*360;
  const rot = faceRotations[to];
  dice.style.transform = `rotateX(${rot.x+extraX}deg) rotateY(${rot.y+extraY}deg)`;
  showDice();
  setTimeout(()=>{ hideDice(); }, 1600);
}

/* ==================== GAME ==================== */
const startBtn = document.getElementById('startBtn');
const rollBtn  = document.getElementById('rollBtn');
const nextBtn  = document.getElementById('nextBtn');
const drawBtn  = document.getElementById('drawBtn');
const turnInfo = document.getElementById('turnInfo');
const playersSel = document.getElementById('players');
const cardTitle = document.getElementById('cardTitle');
const cardText  = document.getElementById('cardText');

/* Nomi giocatori UI */
const toggleNamesBtn = document.getElementById('toggleNames');
const namesBox = document.getElementById('namesBox');
const namesHint = document.getElementById('namesHint');

toggleNamesBtn.addEventListener('click', ()=>{
  const vis = namesBox.style.display !== 'none';
  namesBox.style.display = vis ? 'none' : 'grid';
  namesHint.style.display = vis ? 'none' : 'block';
});

playersSel.addEventListener('change', buildNameInputs);

function buildNameInputs(){
  const n = parseInt(playersSel.value,10);
  namesBox.innerHTML = '';
  for(let i=0;i<n;i++){
    const inp = document.createElement('input');
    inp.type = 'text';
    inp.placeholder = `Nome giocatore ${i+1}`;
    inp.value = playerNames[i] || `Giocatore ${i+1}`;
    inp.dataset.index = i;
    inp.addEventListener('input', updateNamesFromInputs);
    namesBox.appendChild(inp);
  }
  // Taglia eventuali nomi extra se si riduce il numero
  playerNames = Array.from({length:n}, (_,i)=> playerNames[i] || `Giocatore ${i+1}`);
}
function updateNamesFromInputs(){
  const inputs = namesBox.querySelectorAll('input');
  inputs.forEach(inp=>{
    const i = parseInt(inp.dataset.index,10);
    playerNames[i] = inp.value.trim() || `Giocatore ${i+1}`;
  });
  updateTurnInfo(); renderStatus(); renderTokens();
}

startBtn.addEventListener('click', ()=>{
  players = parseInt(playersSel.value,10);
  positions = new Array(players).fill(1);
  // inizializza nomi se vuoti
  if(playerNames.length !== players){ playerNames = Array.from({length:players}, (_,i)=> `Giocatore ${i+1}`); }
  buildBoard(); renderTokens(); markCurrentCell(); renderStatus();
  current = 0; gameOn = true; updateTurnInfo();
  cardTitle.textContent = 'Partenza';
  cardText.textContent  = 'Rolla il dado e muovi dalla casella 1.';
});

function updateTurnInfo(){
  const name = playerNames[current] || `Giocatore ${current+1}`;
  turnInfo.textContent = gameOn ? `Tocca a: ${name}` : '‚Äî';
}

function movePlayer(idx, steps){
  let target = positions[idx] + steps;
  if(target > totalCells) target = totalCells;
  positions[idx] = target;
  renderTokens(); markCurrentCell(); renderStatus();
  if(target === totalCells){
    cardTitle.textContent = `üèÅ ${playerNames[idx] || 'Giocatore '+(idx+1)} √® all‚Äôarrivo!`;
    cardText.textContent = 'Bonus cooperativo: ognuno dice un ‚Äúpasso oltre‚Äù imparato. Vittoria collettiva.';
    gameOn = false; updateTurnInfo();
  }else{
    const cell = cellRefs[target-1];
    if(cell.classList.contains('paura')) drawCategory('paura');
    else if(cell.classList.contains('confine')) drawCategory('confine');
    else if(cell.classList.contains('oltre')) drawCategory('oltre');
    else { cardTitle.textContent='Casella neutra'; cardText.textContent='Condividi: che limite oggi ti ha protetto?'; }
  }
}

rollBtn.addEventListener('click', ()=>{
  if(!gameOn) return;
  const n = 1 + Math.floor(Math.random()*6);
  rollVisual(n);
  setTimeout(()=> movePlayer(current, n), 950);
});

nextBtn.addEventListener('click', ()=>{
  if(!gameOn) return;
  current = (current + 1) % players;
  markCurrentCell(); renderTokens(); renderStatus(); updateTurnInfo();
});

drawBtn.addEventListener('click', ()=>{
  if(!gameOn) return;
  const cell = cellRefs[positions[current]-1];
  if(cell.classList.contains('paura')) drawCategory('paura');
  else if(cell.classList.contains('confine')) drawCategory('confine');
  else if(cell.classList.contains('oltre')) drawCategory('oltre');
  else {
    const pool = ['paura','confine','oltre'];
    drawCategory(pool[Math.floor(Math.random()*pool.length)]);
  }
});

function drawCategory(cat){
  let pool, badge, emoji;
  if(cat==='paura'){ pool=cartePaura; badge='b-paura'; emoji='üò®'; }
  else if(cat==='confine'){ pool=carteConfine; badge='b-confine'; emoji='üöß'; }
  else { pool=carteOltre; badge='b-oltre'; emoji='üå±'; }
  const seed = (current+1) * positions[current] * (Date.now()%7+1);
  const idx  = seed % pool.length;
  const text = pool[idx];
  cardTitle.innerHTML = `<span class="badge ${badge}">${emoji} ${cat.toUpperCase()}</span>`;
  cardText.textContent = text;
}

/* ==================== TABS SOLO MOBILE ==================== */
const tabs = document.querySelectorAll('.tabbtn');
const panels = {
  gioco: document.getElementById('panel-gioco'),
  board: document.getElementById('panel-board'),
  carta: document.getElementById('panel-carta'),
  posizioni: document.getElementById('panel-posizioni')
};
function getGridDims(){ return (window.innerWidth <= 900) ? {cols:6, rows:10} : {cols:10, rows:6}; } // re-declared for bundlers

function applyMobileTabs(){
  const isMobile = window.innerWidth <= 900;
  document.getElementById('tabs').style.display = isMobile ? 'grid' : 'none';
  Object.values(panels).forEach(p=>{
    p.classList.remove('show-mobile'); p.classList.remove('hidden-mobile');
  });
  if(isMobile){ setTab(activeTab || 'gioco'); }
}
let activeTab = 'gioco';
function setTab(name){
  activeTab = name;
  Object.entries(panels).forEach(([key,el])=>{
    if(key===name){ el.classList.add('show-mobile'); el.classList.remove('hidden-mobile'); }
    else{ el.classList.add('hidden-mobile'); el.classList.remove('show-mobile'); }
  });
  tabs.forEach(b=> b.classList.toggle('active', b.dataset.tab===name));
}
tabs.forEach(b=> b.addEventListener('click', ()=> setTab(b.dataset.tab)));

window.addEventListener('resize', ()=>{
  applyMobileTabs();
  const dims = getGridDims();
  const needRebuild = (dims.cols !== sizeCols || dims.rows !== sizeRows);
  if(needRebuild){
    const saved = positions.slice();
    buildBoard();
    positions = saved.map(v=> Math.min(v, totalCells));
    renderTokens(); markCurrentCell();
  } else {
    renderTokens(); markCurrentCell();
  }
}, {passive:true});

/* init */
buildBoard();
applyMobileTabs();
buildNameInputs(); // prepara i campi nomi per il valore iniziale di "players"
</script>
</body>
</html>
