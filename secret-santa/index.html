<!DOCTYPE html>
<html lang="it" data-bs-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Secret Santa</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Boxicons -->
  <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">

  <!-- AOS -->
  <link rel="stylesheet" href="https://unpkg.com/aos@2.3.1/dist/aos.css"/>

  <style>
    body { padding: 30px; }
    .card-custom {
      border-radius: 16px;
      padding: 25px;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      backdrop-filter: blur(10px);
    }
    .link-box {
      background: rgba(255,255,255,0.08);
      padding: 10px;
      border-radius: 8px;
      font-size: .9rem;
      overflow-x: auto;
      white-space: nowrap;
      margin-bottom: 8px;
    }
  </style>
</head>

<body>

<div class="container">

  <!-- SETUP VIEW -->
  <div id="setup" data-aos="fade-up">

    <h1 class="mb-4 text-center"><i class='bx bxs-gift'></i> Secret Santa</h1>

    <div class="card-custom mb-4">
      <label class="form-label">Partecipanti (uno per riga)</label>
      <textarea id="names" class="form-control" rows="6"></textarea>

      <label class="form-label mt-3">Budget (opzionale)</label>
      <input id="budget" class="form-control" placeholder="Es. 15€">
      
      <button class="btn btn-primary mt-3 w-100" onclick="generate()">
        <i class='bx bx-shuffle'></i> Genera Abbinamenti
      </button>
    </div>

    <div id="links"></div>
  </div>

  <!-- VIEWER (per ogni partecipante) -->
  <div id="viewer" style="display:none;" data-aos="fade-up">
    <div class="card-custom">
      <h2 id="viewerTitle" class="text-center mb-4"></h2>
      <div id="resultCard"></div>
    </div>
  </div>

</div>

<!-- JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
<script>AOS.init();</script>

<script>
// Mescola l'array
function shuffle(arr) {
  for (let i = arr.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
}

function generate() {
  const names = document.getElementById("names").value.trim().split("\n").map(n => n.trim()).filter(n => n);
  const budget = document.getElementById("budget").value.trim();

  if (names.length < 2) {
    alert("Servono almeno due partecipanti!");
    return;
  }

  const mixed = [...names];
  shuffle(mixed);

  // Evita che uno peschi se stesso
  for (let i = 0; i < 50; i++) {
    if (names.every((n, idx) => n !== mixed[idx])) break;
    shuffle(mixed);
  }

  const mapping = {};
  names.forEach((p, i) => {
    mapping[p] = { receiver: mixed[i], budget };
  });

  localStorage.setItem("secretSantaData", JSON.stringify(mapping));

  const linksDiv = document.getElementById("links");
  linksDiv.innerHTML = '<h4 class="mt-4">Link privati</h4>';

  names.forEach(name => {
    const link = location.origin + location.pathname + "?you=" + encodeURIComponent(name);
    linksDiv.innerHTML += `
      <div class="link-box">
        <i class='bx bx-user'></i> <strong>${name}</strong>: 
        <a href="${link}" target="_blank">${link}</a>
      </div>`;
  });
}

function viewMode(user) {
  const raw = localStorage.getItem("secretSantaData");
  if (!raw) {
    document.getElementById("resultCard").innerHTML = "Nessun sorteggio salvato.";
    return;
  }

  const data = JSON.parse(raw);
  const entry = data[user];

  if (!entry) {
    document.getElementById("resultCard").innerHTML = "Utente non trovato.";
    return;
  }

  document.getElementById("viewerTitle").textContent = "Ciao " + user + "!";
  document.getElementById("resultCard").innerHTML = `
    <p class="text-center">Il tuo destinatario è:</p>
    <h1 class="text-center my-4"><i class='bx bxs-gift'></i> ${entry.receiver}</h1>
    <p class="text-center"><strong>Budget:</strong> ${entry.budget || "libero"}</p>
  `;
}

// Modalità viewer
const params = new URLSearchParams(location.search);
const me = params.get("you");

if (me) {
  document.getElementById("setup").style.display = "none";
  document.getElementById("viewer").style.display = "block";
  viewMode(me);
}
</script>

</body>
</html>